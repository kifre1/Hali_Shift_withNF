---
title: "Area vs Abundance Analysis"
author: "Nancy Shackell"
date: "`r Sys.Date()`"
output:
  html_document:
    toc: true
    df_print: paged
  word_document:
    toc: true
    highlight: tango
---

```{r setup,include=FALSE}
knitr::opts_chunk$set(
  echo = FALSE,
  message = FALSE,
  warning = FALSE,
  fig.width=10,
  fig.height=8,
  fig.align = "center")
```
```{r load libraries}
library(dplyr)
library(tidyverse)
library(broom)
#library(flextable);library(officer)
library(ggplot2);library(ggrepel) 
library(ggpmisc)  # Make sure this is loaded for stat_poly_eq
library(patchwork)
#library(RColorBrewer); #display.brewer.all(n=NULL, type="all", select=NULL, exact.n=TRUE,#colorblindFriendly=FALSE)
library(grid)  # For unit() function
library(viridis) # For color palettes

theme_set(theme_bw())
```
```{r theme-settings, include=FALSE}
theme_set(theme_bw())
theme_update(
  panel.grid.minor = element_blank(), 
  panel.grid.major = element_blank(),
  strip.background = element_rect(colour="black", fill="white"),
  axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1, size=10),
  axis.text.y = element_text(angle = 0, vjust = 0.5, hjust=1, size=10)
)
```

## Introduction

This analysis explores the relationship between abundance and the area containing different percentages of abundance across regions and years. We'll examine how the spatial distribution of abundance varies over time and across different regions.We finish by regressing Area on abundance, which tells us to what extent an expansion is due to an increase in abundance. 

```{r load-data,include=FALSE}
abdest<- read.csv("~/My_Program_Files/R/Hali_Shift_withNF/2025-04-23/Output/IndexAbundance/AbundanceEstimates_GridCentriods_Reg.csv")
dim(abdest) 
#summary(abdest) #View(abdest) #unique(abdest$Area_km2)
abdest$Region<-factor(abdest$Stratum)
#Note there are 3 seasons that all have different Area_km2 values so x table 
abdest %>%
  group_by(Stratum,Season, Area_km2) %>%
  summarise(n = n()) %>%
  pivot_wider(names_from = Area_km2, values_from = n)
#Select for Spring
abdest.spr<- abdest %>%
  filter(Season == "Spring")

abdest.spr<-abdest.spr %>%
  group_by(Region,Year) %>%
  mutate(AnnualAbundance = sum(Abundance))
#dim(abdest.spr);names(abdest.spr)

```

```{r summarize-data,include=FALSE}
# Display dataset dimensions and column names
#dim(abdest.spr)
#names(abdest.spr)

# Calculate annual abundance by region and year
abdest.spr <- abdest.spr %>%
  group_by(Region, Year) %>%
  mutate(AnnualAbundance = sum(Abundance))
```
## Calculating Area Thresholds

We'll calculate the area containing different percentages of abundance (50%, 75%, 90%, 95%) for each region and year:

```{r calculate-areas}
# Function to calculate area for different abundance thresholds
calculate_areas <- function(data, thresholds = c(50, 75, 90, 95)) {
  result_list <- list()
  
  for (threshold in thresholds) {
    threshold_result <- data %>%
      group_by(Region, Year) %>%
      mutate(Total_Abundance = sum(Abundance)) %>%
      arrange(Region, Year, desc(Abundance/Area_km2)) %>%
      mutate(
        Cumulative_Abundance = cumsum(Abundance),
        Percent_Abundance = Cumulative_Abundance / Total_Abundance * 100,
        Cumulative_Area = cumsum(Area_km2)
      ) %>%
      filter(Percent_Abundance <= threshold) %>%
      summarize(
        Threshold = threshold,
        Area_Threshold = sum(Area_km2),
        Total_Area = sum(Area_km2, na.rm = TRUE),
        Percent_Area_Used = Area_Threshold / sum(Area_km2, na.rm = TRUE) * 100,
        Total_Abundance = first(Total_Abundance),
        n_cells = n()
      )
    
    result_list[[as.character(threshold)]] <- threshold_result
  }
  
  # Combine all results
  bind_rows(result_list)
}

# Apply the function to calculate areas for different thresholds
area_thresholds <- calculate_areas(abdest.spr)

# Calculate area efficiency (area per unit of abundance)
area_thresholds <- area_thresholds %>%
  mutate(Area_Efficiency = Area_Threshold / Total_Abundance)
area_thresholds$Period<-NULL
area_thresholds$Period[area_thresholds$Year<2006]<-"Before Warming"
area_thresholds$Period[area_thresholds$Year>2005]<-"During Warming"
# Preview the results
head(area_thresholds)
write.csv(area_thresholds, 
          file = here::here("R/DataforFinalFigs/Area_ThresholdsforEAO.csv"),row.names = FALSE)
```

## Visualizing the Results

### 1. Area Containing 90% of Abundance by Region and Year

```{r plot-area-by-region-year}
P1<-ggplot(area_thresholds %>% filter(Threshold == 90), 
       aes(x = as.factor(Year), y = Area_Threshold, fill = Region)) +
  geom_bar(stat = "identity", position = "dodge") +
  labs(title = "Area Containing 90% of Abundance", 
       x = "Year", 
       y = "Area (km²)",
       fill = "Region") +
  theme_minimal() +
  scale_fill_viridis_d() # Color-blind friendly palette
P1
```

### 2. Trends Over Time

Canadians trending upwards, Americans trending slightly downwards.


```{r plot-trends}
P2<-ggplot(area_thresholds %>% filter(Threshold == 90), 
       aes(x = Year, y = Area_Threshold, color = Region, group = Region)) +
  geom_line(size = 1) +
  geom_point(size = 3) +
  labs(title = "Trend in Area Containing 90% of Abundance", 
       x = "Year", 
       y = "Area (km²)",
       color = "Region") +
  theme_minimal() +
  scale_color_viridis_d()
P2

```

### 3. Multiple Thresholds Comparison
The multiple thresholds rank similarly within year (at least for Canada), so we will use D90 (not shown but see md for the code)

```{r plot-thresholds,include=FALSE,eval=FALSE}
P3<-ggplot(area_thresholds, 
       aes(x = as.factor(Threshold), y = Area_Threshold, fill = Region)) +
  geom_bar(stat = "identity", position = "dodge") +
  facet_wrap(~Year, scales = "free_y") +
  labs(title = "Area Containing Different Percentages of Abundance", 
       x = "Abundance Threshold (%)", 
       y = "Area (km²)",
       fill = "Region") +
  theme_minimal() +
  scale_fill_viridis_d()
P3
```


### 4. All Thresholds Over Time

Similar temporal trends across thresholds, so can safely use D90.(#3 not shown here, but see md for the code to make it.)


```{r plot-all-thresholds}
P5<-ggplot(area_thresholds, 
       aes(x = Year, y = Area_Threshold, color = as.factor(Threshold), group = Threshold)) +
  geom_line(size = 1) +
  geom_point(size = 2) +
  facet_wrap(~Region, scales = "free_y") +
  labs(title = "Area Required for Different Abundance Thresholds Over Time", 
       x = "Year", 
       y = "Area (km²)",
       color = "Abundance\nThreshold (%)") +
  theme_minimal() +
  scale_color_viridis_d()
P5
```

##  Annual Abundance vs Area Analysis

### 1. Scatter Plot by Region

```{r scatter-by-region}
P6<-ggplot(area_thresholds %>% filter(Threshold == 90),
       aes(y =Area_Threshold, x =Total_Abundance)) +
  geom_point(size = 4, alpha = 0.7) +
  geom_text(aes(label = Year), vjust = -0.5, hjust = 0.5, size = 3) +
  labs(title = "Area Containing 90% of Abundance vs Total Annual Abundance",
       y = "Area (sqkm)",
       x = "Total Annual Abundance") +
  theme_minimal() +facet_wrap(~Region, scales = "free") 

P6
```


### 2. Another way to look at how EAO is distributed with abundance over time

```{r facet-by-region}
P8<-ggplot(area_thresholds %>% filter(Threshold == 90),
       aes(x = Total_Abundance, y = Area_Threshold, color = as.factor(Year))) +
  geom_point(size = 4, alpha = 0.8) +
  geom_line(aes(group = Region)) +
  facet_wrap(~Region, scales = "free") +
  labs(title = "Area vs Annual Abundance by Region",
       x = "Total Annual Abundance",
       y = "Area (sqkm)",
       color = "Year") +
  theme_minimal() +
  scale_color_viridis_d()
P8
```

## Area vs Abundance with Regression Lines and slopes

Canada and US have opposite trends, with Canada having a positive slope and the US having a negative slope.
From Thorson" 
goal" relationship between totalabundance in biomass (b) and effective area occupied (h) - a linear model between the logarithm of abundance and the logarithm of area occupied for all yearsin a given region. Slope represents the average relationship. If slope is 0,  a change in abundance has no association on average with changes in area occupied,and this provides support for the ‘proportional-density’ model. Similarly, if slope is >0, a 1% increase/decrease in abundance is associated with Slope% increase/decrease in area occupied.Slope can be interpreted as the proportion of abundance change that is explained by change in effective area occupied, whereas 1-slope is the proportion that is explained by increases in average density. If slope =0.5 , means that increases in abundance and d equally to both range expansion and increases in density.
,,,do I have this backwards? see Thorson et al. https://royalsocietypublishing.org/doi/epdf/10.1098/rspb.2016.1853

If I don;t have it backwards, then in Canada, for every 1% increase, 0.3% increase in EAO. In US, for every 1% increase, 0.2% decrease in EAO. I have to read that again OR we can just look at the slopes and see if they are positive or negative: As abundance increases in Canada, EAO increases, and as abundance increases in the US, EAO decreases. The halibut in US are concentrating in smaller areas, while the halibut in Canada are spreading out over larger areas. 

```{r fit slopes}
P9<-ggplot(area_thresholds %>% filter(Threshold == 90),
       aes(y =log10(Area_Threshold), x =log10(Total_Abundance))) +
  geom_point(size = 2, alpha = 0.8) +
  geom_smooth(method = "lm", se = T,aes(group = 1)) +
  stat_poly_eq(
    aes(label = paste(after_stat(eq.label), ..rr.label.., sep = "~~~")),
    formula = y ~ x,
    parse = TRUE,
    label.x.npc = "left",
    label.y.npc = 0.9,
    size = 3,
    color = "black"
  ) +
  facet_wrap(~Region, scales = "free") +
  labs(title = " Area vs Annual Abundance by Region",
       x= "Total Annual Abundance",
       y = "Area (sqkm)",
       color = "Year") +
  theme_minimal()
  P9
 p10<- ggplot(area_thresholds %>% filter(Threshold == 90),
       aes(y = log10(Area_Threshold), x = log10(Total_Abundance))) +
  geom_point(aes(color = Period), size = 2, alpha = 0.8) +
  geom_smooth(method = "lm", se = TRUE,
              aes(group = interaction(Region, Period), color = Period)) +
  stat_poly_eq(
    aes(group = interaction(Region, Period), color = Period,
        label = paste(after_stat(eq.label),
                      after_stat(rr.label),
                      after_stat(p.value.label), sep = "~~~")),
    formula = y ~ x,
    parse = TRUE,
    label.x.npc = "left",
    label.y.npc = 0.9,
    size = 3
  ) +
  facet_wrap(~Region, scales = "free") +
  labs(title = "Area vs Annual Abundance by Region",
       x = "Total Annual Abundance",
       y = "Area (sqkm)",
       color = "Period") +
  theme_minimal()

 p10

```

### 4. Area Efficiency Over Time

The formula from Claude.ai was 
"Calculate area efficiency (area per unit of abundance)"
"area_thresholds <- area_thresholds %>%
  mutate(Area_Efficiency = Area_Threshold / Total_Abundance)"

The area efficiency metric (area per unit of abundance) helps identify regions where abundance is more concentrated or dispersed. Lower values indicate greater concentration of abundance in smaller areas.

  Both regions show a decrease in area efficiency over time, indicating that the area required to contain a unit of abundance is decreasing. This could suggest that abundance is becoming more concentrated in smaller areas over time.
```{r efficiency-plot}
P9<-ggplot(area_thresholds %>% filter(Threshold == 90),
       aes(x = Year, y = Area_Efficiency, color = Region, group = Region)) +
  geom_line(size = 1) +
  geom_point(size = 3) +
  labs(title = "Area Efficiency Over Time", 
       subtitle = "Area (km²) needed per unit of abundance",
       x = "Year", 
       y = "Area per Abundance Unit (km²)",
       color = "Region") +
  theme_minimal() +
  scale_color_viridis_d()
P9
```



```{r concentration-plot,include=FALSE,eval=FALSE}
## Abundance Concentration Efficiency
P11<-ggplot(area_thresholds, 
       aes(x = Percent_Area_Used, y = Threshold, color = Region)) +
  geom_point(size = 3) +
  geom_line(aes(group = interaction(Region, Year))) +
  facet_wrap(~Year) +
  labs(title = "Abundance Concentration Efficiency", 
       x = "% of Total Area Used", 
       y = "% of Total Abundance",
       color = "Region") +
  theme_minimal() +
  scale_color_viridis_d() +
  geom_abline(intercept = 0, slope = 1, linetype = "dashed", color = "gray") +
  annotate("text", x = 75, y = 25, label = "Equal distribution line", 
           color = "gray", angle = 45)
P11
```

## Conclusion

This analysis provides insights into how abundance is distributed spatially across regions and how this distribution changes over time. The area required to contain 90% of abundance varies by region and year, potentially indicating changes in population concentration or dispersion over time.  In Canada, the EAO is expanding with abundance and density is increasing in those areas. In the US, the EAO is decreasing with abundance and density is increasing in those contracted areas.(Check what is happening in Nantucket and Cape Cod and GB, likely the increases are largely occuring in EGM)



